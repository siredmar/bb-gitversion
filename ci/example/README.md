<img src="https://raw.githubusercontent.com/elbb/bb-buildingblock/master/.assets/logo.png" height="200">

# Concourse pipeline integration guide

For using this concourse CI pipeline it is recommended to have two config files:

-   `config.yaml`: for production purposes
-   `config.local.yaml`: for development and testing purposes

The `config.yaml` is used to access the projects production release repository and branch and a real cloud S3 endpoint to store version artifacts.
The `config.local.yaml` is used to develop and test the pipeline for building blocks. It is used to work with your private fork or local git repository, your local docker registry as well as a local S3 endpoint.

# Example concourse CI pipeline

This example is intended to show the integration of a build pipeline in a derived building block.

## Adaptions for your building block

This section describes what needs to be done within the several files. 
**Note: Files called `credentials.yaml` are ignored by `.gitignore` and will not be checked in.**

### config.example.yaml

Open the `config.example.yaml` and specify the fields that are described.
This config file shows an example for a fictive building block called `bb-example`.

Note: If you are using a real S3 endpoint you should enter those data. If you are using the local test environment specify like below.
Note: If you are using e.g. dockerhub, you can specify `destination: elbb/bb-example`

    ---
    # General stuff
    # -------------
    ## Specifies the name of the buildingblock
    name: bb-example
    ## Specifies the destination of the docker image artifact
    # using docker host ip address for local testing, 
    destination: http://172.17.0.1:5000/elbb/bb-example
    ## Specifies the version used for bb-gitversion
    bb-gitversion-version: 0.2.0

    # Git relevant stuff
    # ------------------
    ## Specify the git repository to work with
    git_source: https://github.com/elbb/bb-example
    ## Specify the branch to work with
    git_branch: master
    ## This enables/disables ssl verification of the git resource
    git_skip_ssl_verification: false

    # S3 relevant stuff
    # -----------------
    ## Specify the S3 endpoint URI
    # using docker host ip address for local testing
    s3_endpoint: http://172.17.0.1:9000
    ## This enables/disables the ssl verification for the S3 endpoint
    s3_disable_ssl: true

### credentials.example.yaml

**Note: Make sure that you have set up ssh access with your ssh-key in your git repository.**

Fill in your ssh private key and your S3 credentials in `credentials.example.yaml` and rename it to `credentials.yaml`.

### pipeline.example.yaml

We assume that the git repository for bb-example contains parts the following file structure:

    .
    ├── docker
    |   ├── Dockerfile

As a build artifact a docker image is wanted versioned with bb-gitversion.

Adapt the last section in the `pipeline.example.yaml` to match your needs. 
The example builds the docker image with the Dockerfile located in `docker/Dockerfile` and creates a tag generated by a previous step running `bb-gitversion`.

      ...
      - name: Create docker image for ((name)) and push it
        public: true
        plan:
          - in_parallel:
              - get: source
              - get: s3-gitversion
                params:
                  unpack: true
          - put: image-((name))
            params:
              build: source/docker
              dockerfile: source/docker/Dockerfile
              additional_tags: s3-gitversion/plain/SemVer
              tag_as_latest: true

## Using the pipeline

Use `fly` to setup the pipeline with concourse CI.
Before setting the pipeline you might login first to your concourse instance `fly -t <target> login --concourse-url http://<concourse>:<port>`. See the [fly documentation](https://concourse-ci.org/fly.html) for more help.

Once you've setup your concourse CI server (either hosted or local) upload the pipeline:

    $ fly -t <target> set-pipeline -n -p bb-example -l ci/config.example.yaml -l ci/credentials.yaml -c pipeline.example.yaml
